@model IEnumerable<arTWander.Models.CommonViewModel.CommonMyItineraryPage>
@{
    Layout = "~/Views/Shared/CommonLayout/_AsideFalse.cshtml";
}

<div class="py-5">
    <div>
        <h4 class="col-6 col-md-4 px-0 my-auto itineraryIcon font-weight-bold">請選擇您的看展時段</h4>
        <hr>
        <br>
    </div>

    <!-- 區域選擇 -->
    <div class="container mb-3">
        <div class="d-flex my-auto px-0">
            <div class="row w-100 justify-content-start">
                <label for="StartDate" class="col-6 col-lg-2 my-auto pl-0">逛展日期 </label>
                <input type="date" class="form-control col-6 col-lg-4" id="StartDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
            </div>
        </div>
    </div>
    <!-- 時間選擇 -->
    <div class="container mb-3">
        <div class="row my-3">
            <div class="col-12 col-md-6 mx-0">
                <div class="d-flex my-auto px-0">
                    <div class="row w-100 justify-content-start">
                        <label for="StartTime" class="col-12 my-auto pl-0">展覽開始時間 </label>

                        <select class="form-control ml-1 col-12" id="StartTime" multiple size="5">
                            @*<option value="" selected disabled>請選擇開始時間</option>*@
                            <option value="08:00" selected>08:00</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>
                            <option value="19:00">19:00</option>
                            <option value="20:00">20:00</option>
                            <option value="21:00">21:00</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="d-flex my-auto px-0">
                    <div class="row w-100 justify-content-start">
                        <label for="EndTime" class="col-12 my-auto pl-0">展覽結束時間 </label>
                        <select class="form-control ml-1 col-12" id="EndTime" multiple size="5">
                            @*<option value="" selected disabled>請選擇結束時間</option>*@
                            <option value="08:00">08:00</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>
                            <option value="19:00">19:00</option>
                            <option value="20:00">20:00</option>
                            <option value="21:00" selected>21:00</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 主畫面資料導入 -->
<div class="container px-0 col-12">
    <div class="py-5">
        <div>
            <h4 class="col-6 col-md-6 px-0 my-auto itineraryIcon font-weight-bold">請選擇您本次預計參觀的展覽</h4>
            <hr>
            <br>
        </div>
        <!-- 選擇打算參加展覽導入 -->
        <!-- 顯示訂單內縣市展演 start -->
        <div class="showJoin col-12 px-0 ">
            <!-- 顯示訂單內縣市展演 start -->
            <div class="form-group row">
                <label for="FK_City" class="col-sm-2 col-form-label">請選擇縣市</label>
                <div class="col-sm-10">
                    <select class="form-control" id="FK_City" name="FK_City">
                        <option value="0">全部縣市</option>
                        @foreach (var item in Model.Select(m => m.city))
                        {
                            <option value="@item.Id">@item.CityName</option>
                        }
                    </select>
                </div>
            </div>
            <div class="showCityBorder py-0">
                <table id="MyShowPage" class="table table-borderless my-auto">
                    @{ Html.RenderPartial("~/Views/Shared/CommonPartial/Card/_PartialMyItineraryShowList.cshtml", Model);}
                </table>
            </div>
        </div>
        <!-- 顯示訂單內縣市展演 end -->
        <!-- 本次行程排序 -->
        <div class="showSort col-12 px-0 py-5">
            <div>
                <h4 class="col-6 col-md-4 px-0 my-auto itineraryIcon font-weight-bold">請為本次行程排序</h4>
                <hr>
                <br>
            </div>
            <!-- 顯示訂單內縣市展演 start -->
            <div class="showJoin col-12 mt-3">
                <!-- 顯示訂單內縣市展演 start -->
                <div class="showCityBorder py-0">
                    <table class="table table-borderless my-auto">
                        <tbody id="sortable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- 顯示訂單內縣市展演 end -->
        <!-- 輸入出發地點 start-->
        <div class="startPosition col-12 px-0 py-5">
            <div>
                <h4 class="col-6 col-md-4 px-0 my-auto font-weight-bold">請輸入您的出發地點</h4>
                <hr>
                <br>
            </div>
            <div class="mt-3 d-flex flex-column align-items-center">
                <label style="font-size:20px;">1.設定路線規劃方式</label>
                <ul class="nav nav-pills mb-5 w-100" id="travelMode" role="tablist">
                    <li class="nav-item flex-fill" role="presentation">
                        <a class="nav-link text-center active" href="" style="text-decoration:none;color:black; font-weight:bold;" data-toggle="pill" role="tab" aria-mode="" aria-controls="pills-best" aria-selected="true">最佳路線</a>
                    </li>
                    <li class="nav-item flex-fill" role="presentation">
                        <a class="nav-link text-center" href="" data-toggle="pill" role="tab" aria-mode="driving" aria-controls="pills-home" aria-selected="false"><i class="fas fa-car" style="font-size: 28px;"></i></a>
                    </li>
                    <li class="nav-item flex-fill" role="presentation">
                        <a class="nav-link text-center" href="" data-toggle="pill" role="tab" aria-mode="bicycling" aria-controls="pills-profile" aria-selected="false"><i class="fas fa-biking" style="font-size: 28px;"></i></a>
                    </li>
                    <li class="nav-item flex-fill" role="presentation">
                        <a class="nav-link text-center" href="" data-toggle="pill" role="tab" aria-mode="walking" aria-controls="pills-contact" aria-selected="false"><i class="fas fa-walking" style="font-size: 28px;"></i></a>
                    </li>
                </ul>
                <label for="positionOrAddr" style="font-size:20px;">2.設定出發地點</label>
                @*<div class="form-group w-100 mb-5">
            <input type="text" class="form-control w-100" ref="site" v-model="site">
        </div>*@
                <div class="input-group w-100 mb-5" id="app">
                    <input type="text" id="positionOrAddr" class="form-control" ref="site" v-model="site" v-on:change="getCurrentAddr">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" onclick="getPosition()" data-toggle="tooltip" data-placement="bottom" title="取得目前所在位置"><i class="fas fa-map-marker-alt"></i></button>
                    </div>
                </div>
                <div class="col-6 col-md-4 mx-auto mt-3">
                    <button type="button" onclick="getAddrsUrl(event)" href="#" class="btn btn-outline-secondary border-0 bg-pink text-white w-100">開始規劃路線</button>
                </div>
                
            </div>
        </div>
        <!-- 輸入出發地點 end-->
        <!-- 地圖建議路線 start-->
        <div class="startPosition col-12 px-0">
            <div class="mb-4">
                <h4 class="col-6 col-md-4 px-0 my-auto mt-3 font-weight-bold">建議路線</h4>
                <hr>
            </div>

            <!-- 導入地圖api -->
            <div>
                <iframe id="resultUrl" src="" width="100%" height="500" style="border:1px solid black;"></iframe>
            </div>
            <div class="col-6 col-md-4 mx-auto mt-3">
                <button type="button" id="sendToEmail" class="btn btn-secondary border-0 bg-pink text-white w-100">將路線寄送至Email</button>
            </div>
        </div>
        <!-- 地圖建議路線 end-->
    </div>
</div>
@section css{
    <style>

        .addShowPage {
            border-style: none;
            background-color: transparent;
        }

            .addShowPage > i {
                font-size: 12px;
            }


        .controlBtn {
            border-style: none;
            background-color: transparent;
            margin-left: 7px;
        }

        .showPageUrl {
            text-decoration: none;
            color: black;
            transition: all .3s ease-in-out;
        }

            .showPageUrl:hover {
                text-decoration: none;
                color: rgb(197, 126, 104);
            }
    </style>

    @*載入Google map api - 搜尋框自動完成地址功能*@
    <link rel="canonical" href="https://letswrite.tw/google-map-api-place-api/">
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="~/Content/spinkit.min.css" rel="stylesheet" />
}

@section scripts{

    @*載入Google map api - 搜尋框自動完成地址功能*@
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkbzgPohvus20UjyVFUYAW0rNnBlXBGM0&libraries=places"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>

    <script>

        //iframe的網址，呈現Google Map導航路線
        let searchCenter = '';

        //Google Map路線網址
        let googleMapUrl = '';

        $(function () {
            $("#sortable").sortable();

            $('#StartDate').change(function () {
                searchShowPage();
                $('#sortable').html('');
            });

            $('#StartTime').change(function () {
                searchShowPage();
                $('#sortable').html('');
            });

            $('#EndTime').change(function () {
                searchShowPage();
                $('#sortable').html('');
            });

            $('#FK_City').change(function () {
                searchShowPage();
            });

            $('#sendToEmail').click(function () {
                sendRountToEmail();
            });

            const googleMap = new Vue({
                el: '#app',
                data: {
                    map: null,
                    autocomplete: null,
                    site: '', // place API要綁定的搜尋框
                    place: null // 存place確定後回傳的資料
                },
                methods: {
                    // 地址自動完成 + 地圖的中心移到輸入結果的地址上
                    siteAuto() {
                        let options = {
                            componentRestrictions: {
                                country: 'tw'
                            } // 限制在台灣範圍
                        };
                        this.autocomplete = new google.maps.places.Autocomplete(this.$refs.site, options);
                        //this.autocomplete.addListener('place_changed', () => {
                        //    this.place = this.autocomplete.getPlace();
                        //    if (this.place.geometry) {
                        //        //searchCenter = this.place.geometry.location;
                        //        searchCenter = this.place.formatted_address;
                        //    }
                        //});
                    },
                    getCurrentAddr: function (event) {
                        searchCenter = event.target.value;
                        googleMapUrl = '';
                    }
                },
                mounted() {
                    window.addEventListener('load', () => {
                        this.siteAuto();
                    });
                }
            });
        });

        //取得使用者目前所在位置
        function getPosition() {
            if (navigator.geolocation) {

                // 使用者不提供權限，或是發生其它錯誤
                function error() {
                   Swal.fire({
                        icon: 'error',
                        title: '錯誤',
                        text: '無法取得你的位置',
                        showConfirmButton: false,
                        showCancelButton: true
                    });
                }

                // 使用者允許抓目前位置，回傳經緯度
                function success(position) {
                    //console.log(position.coords.latitude, position.coords.longitude);
                    $('#positionOrAddr').val(`${position.coords.latitude},${position.coords.longitude}`);
                    searchCenter = `${position.coords.latitude},${position.coords.longitude}`;
                    googleMapUrl = '';
                }

                // 跟使用者拿所在位置的權限
                navigator.geolocation.getCurrentPosition(success, error);

            } else {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: 'Sorry, 你的裝置不支援地理位置功能。',
                    showConfirmButton: false,
                    showCancelButton: true
                });

                $('#positionOrAddr').val('');
            }
        }

        //取得多個地點的導航路線
        function getAddrsUrl(event) {

            if (searchCenter == '') {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: '未設定出發地點',
                    showConfirmButton: false,
                    showCancelButton: true
                });
                return false;
            }

            let addrDOMs = document.querySelectorAll('#sortable>tr>td[aria-address]');
            let mode = document.querySelectorAll('#travelMode>li>a[aria-selected="true"]').item(0).getAttribute('aria-mode');

            let url = '';

            if (addrDOMs.length >= 2) {
                url = `https://www.google.com/maps/embed/v1/directions?&key=AIzaSyAkbzgPohvus20UjyVFUYAW0rNnBlXBGM0&origin=${searchCenter}&waypoints=`;
                googleMapUrl = `https://www.google.com/maps/dir/?api=1&origin=${searchCenter}&waypoints=`;
                for (let index in addrDOMs) {
                    if (addrDOMs[index].nodeType == 1) {
                        if (index == addrDOMs.length - 1) {
                            url = url.slice(0, url.length - 1);
                            googleMapUrl = googleMapUrl.slice(0, googleMapUrl.length - 1);

                            url += `&destination=${addrDOMs[index].getAttribute('aria-address')}`;
                            googleMapUrl += `&destination=${addrDOMs[index].getAttribute('aria-address')}`;
                        } else {
                            url += `${addrDOMs[index].getAttribute('aria-address')}|`;
                            googleMapUrl += `${addrDOMs[index].getAttribute('aria-address')}|`;
                        }
                    }
                }
            } else if (addrDOMs.length == 1) {
                url = `https://www.google.com/maps/embed/v1/directions?&key=AIzaSyAkbzgPohvus20UjyVFUYAW0rNnBlXBGM0&origin=${searchCenter}&destination=${addrDOMs[0].getAttribute('aria-address')}`;

                googleMapUrl = `https://www.google.com/maps/dir/?api=1&origin=${searchCenter}&destination=${addrDOMs[0].getAttribute('aria-address')}`;

            } else {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: '未安排展覽行程',
                    showConfirmButton: false,
                    showCancelButton: true
                });

                return false;
            }

            if (mode != '') {
                url += `&mode=${mode}`;
                googleMapUrl += `&travelmode=${mode}`;
            }

            let resultUrl = document.getElementById('resultUrl');
            resultUrl.setAttribute('src', url);
        }

        function sendRountToEmail() {
            if (googleMapUrl == '') {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: '沒有規劃路徑',
                    showConfirmButton: false,
                    showCancelButton: true
                });
                return false;
            }

            $('#sendToEmail').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>正在寄送中...');
            $('#sendToEmail').attr("disabled", true);
            $.ajax({
                type: 'get',
                url: '@Url.Action("SendRountToEmail", "Common")',
                data: { url: googleMapUrl },
                dataType: 'script',
                success: function (data) {
                    eval(data);
                    $('#sendToEmail').html('將路線寄送至Email');
                    $('#sendToEmail').removeAttr("disabled");
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    Swal.fire({
                        icon: 'error',
                        title: textStatus,
                        text: errorThrown,
                        showConfirmButton: false,
                        showCancelButton: true
                    });
                    $('#sendToEmail').html('將路線寄送至Email');
                    $('#sendToEmail').removeAttr("disabled");
                }
            });
        }

        /*依據日期時間篩選符合的展覽*/
        function searchShowPage() {
            let cityId = $('#FK_City').val();
            let StartDate = $('#StartDate').val();
            let StartTimeStr = document.getElementById('StartTime').value;
            let EndTimeStr = document.getElementById('EndTime').value;
            //console.log($('#StartDate').val());
            //if (StartDate == '') {

            //    let today = new Date();
            //    $('#StartDate').val(`${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`);
            //    StartDate = $('#StartDate').val();
            //}

            //if (StartTimeStr == '') {
            //    document.getElementById('StartTime').selectedIndex = 1;
            //    StartTimeStr = document.getElementById('StartTime').value;
            //}

            //if (EndTimeStr == '') {
            //    let optionSize = document.getElementById('EndTime').options.length;
            //    document.getElementById('EndTime').selectedIndex = optionSize - 1;
            //    EndTimeStr = document.getElementById('EndTime').value;
            //}

            loadingShowPages();

            $.ajax({
                type: 'get',
                url: '@Url.Action("getMyShow", "Common")',
                data: { cityId: cityId, StartDate: StartDate, StartTime: StartTimeStr, EndTime: EndTimeStr },
                success: function (data) {
                    $('#MyShowPage').html(data);
                    googleMapUrl = '';
                    searchCenter = '';
                    $('#positionOrAddr').val('');
                }, error: function (jqXHR, textStatus, errorThrown) {
                    Swal.fire({
                        icon: 'error',
                        title: textStatus,
                        text: errorThrown,
                        showConfirmButton: false,
                        showCancelButton: true
                    });
                }
            });
        }

        //新增展覽至行程排序
        function addShowPage(event) {
            let sibling = event.target;

            //取得父元素＝'td'
            do {
                sibling = sibling.parentElement;
            } while (sibling.nodeName != 'TD');

            console.log(sibling.nextElementSibling.getAttribute('aria-showid'));
            let getShowId = sibling.nextElementSibling.getAttribute('aria-showid');
            let checkDuplicateAdd = false;

            $('#sortable>tr>td[aria-showId]').each(function (index, element) {
                if (element.getAttribute('aria-showId') == getShowId) {
                    checkDuplicateAdd = true;
                }
            });

            if (checkDuplicateAdd) {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: '此展覽已加入至我的行程',
                    showConfirmButton: false,
                    showCancelButton: true
                });

                return false;
            }

            //複製元素
            sibling = sibling.nextElementSibling.cloneNode(true);

            let trSize = document.querySelectorAll('#sortable>tr').length;

            let thTag = document.createElement('th');
            thTag.textContent = `${trSize + 1}`;
            thTag.setAttribute('scope', 'row');

            let controls = document.createElement('td');
            controls.className = 'btn-group';

            //up
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="upShowPage(event)"><i class="fas fa-chevron-up"></i></button>';

            //down
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="downShowPage(event)"><i class="fas fa-chevron-down"></i></button>';

            //top
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="topShowPage(event)"><i class="fas fa-angle-double-up"></i></button>';

            //last
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="lastShowPage(event)"><i class="fas fa-angle-double-down"></i></button>';

            //remove
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="removeShowPage(event)"><i class="fa fa-minus"></i></button>';

            let trTag = document.createElement('tr');
            trTag.appendChild(thTag);//th
            trTag.appendChild(sibling);//td
            trTag.appendChild(controls);//td

            document.getElementById('sortable').appendChild(trTag);
        }

        function upShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.firstElementChild)
                return;

            let temp = target.cloneNode(true);
            parent.insertBefore(temp, target.previousElementSibling);
            parent.removeChild(target);
        }

        function downShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.lastElementChild)
                return;

            parent.insertBefore(target.nextElementSibling, target);
        }

        function topShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.firstElementChild)
                return;

            let temp = target.cloneNode(true);

            parent.replaceChild(parent.firstElementChild, target);
            parent.insertBefore(temp,parent.firstElementChild);
        }

        function lastShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.lastElementChild)
                return;

            let temp = target.cloneNode(true);

            parent.replaceChild(parent.lastElementChild, target);
            parent.appendChild(temp);
        }

        //從行程排序移除展覽
        function removeShowPage(event) {
            let target = event.target;

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            document.getElementById('sortable').removeChild(target);
        }

        function loadingShowPages() {
            $('#MyShowPage').html('<div class="sk-wave" style="margin:50px auto;"><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div></div>');
        }

        function errorServerMsg() {
            $('#showPages').html('<br /><br /><h1>伺服器發生錯誤，無法取得資料</h1>');
        }
    </script>
}