@model IEnumerable<arTWander.Models.CommonViewModel.CommonMyItineraryPage>
@{
    Layout = "~/Views/Shared/CommonLayout/_AsideFalse.cshtml";
}

<div class="py-5">
    <div>
        <h4 class="col-6 col-md-4 px-0 my-auto itineraryIcon font-weight-bold">請選擇您的看展時段</h4>
        <hr>
        <br>
    </div>

    <!-- 區域選擇 -->
    <div class="container mb-3">
        <div class="d-flex my-auto px-0">
            <div class="row w-100 justify-content-start">
                <label for="StartDate" class="col-6 col-lg-2 my-auto pl-0">逛展日期 </label>
                <input type="date" class="form-control col-6 col-lg-4" id="StartDate">
            </div>
        </div>
    </div>
    <!-- 時間選擇 -->
    <div class="container mb-3">
        <div class="row my-3">
            <div class="col-12 col-md-6 mx-0">
                <div class="d-flex my-auto px-0">
                    <div class="row w-100 justify-content-start">
                        <label for="StartTime" class="col-12 my-auto pl-0">展覽開始時間 </label>

                        <select class="form-control ml-1 col-12" id="StartTime" multiple size="5">
                            <option value="" selected disabled>請選擇開始時間</option>
                            <option value="08:00">08:00</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>
                            <option value="19:00">19:00</option>
                            <option value="20:00">20:00</option>
                            <option value="21:00">21:00</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="d-flex my-auto px-0">
                    <div class="row w-100 justify-content-start">
                        <label for="EndTime" class="col-12 my-auto pl-0">展覽結束時間 </label>
                        <select class="form-control ml-1 col-12" id="EndTime" multiple size="5">
                            <option value="" selected disabled>請選擇結束時間</option>
                            <option value="08:00">08:00</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>
                            <option value="19:00">19:00</option>
                            <option value="20:00">20:00</option>
                            <option value="21:00">21:00</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 主畫面資料導入 -->
<div class="container px-0 col-12">
    <div class="py-5">
        <div>
            <h4 class="col-6 col-md-6 px-0 my-auto itineraryIcon font-weight-bold">請選擇您本次預計參觀的展覽</h4>
            <hr>
            <br>
        </div>
        <!-- 選擇打算參加展覽導入 -->
        <!-- 顯示訂單內縣市展演 start -->
        <div class="showJoin col-12 px-0 ">
            <!-- 顯示訂單內縣市展演 start -->
            <div class="form-group row">
                <label for="FK_City" class="col-sm-2 col-form-label">請選擇縣市</label>
                <div class="col-sm-10">
                    <select class="form-control" id="FK_City" name="FK_City">
                        <option value="0">全部縣市</option>
                        @foreach (var item in Model.Select(m => m.city))
                        {
                            <option value="@item.Id">@item.CityName</option>
                        }
                    </select>
                </div>
            </div>
            <div class="showCityBorder py-0">
                <table id="MyShowPage" class="table table-borderless my-auto">
                    @{ Html.RenderPartial("~/Views/Shared/CommonPartial/Card/_PartialMyItineraryShowList.cshtml", Model);}
                </table>
            </div>
        </div>
        <!-- 顯示訂單內縣市展演 end -->
        <!-- 本次行程排序 -->
        <div class="showSort col-12 px-0 py-5">
            <div>
                <h4 class="col-6 col-md-4 px-0 my-auto itineraryIcon font-weight-bold">請為本次行程排序(可用拖曳方式排序)</h4>
                <hr>
                <br>
            </div>
            <!-- 顯示訂單內縣市展演 start -->
            <div class="showJoin col-12 mt-3">
                <!-- 顯示訂單內縣市展演 start -->
                <div class="showCityBorder py-0">
                    <table class="table table-borderless my-auto">
                        <tbody id="sortable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- 顯示訂單內縣市展演 end -->
        <!-- 輸入出發地點 start-->
        <div class="startPosition col-12 px-0 py-5">
            <div>
                <h4 class="col-6 col-md-4 px-0 my-auto font-weight-bold">請輸入您的出發位置</h4>
                <hr>
                <br>
            </div>
            <form action="" class="mt-3 d-flex flex-column align-items-center">
                <div class="form-group w-100 mb-5">
                    <textarea class="form-control w-100" id="exampleFormControlTextarea1" rows="1"></textarea>
                </div>
                <input class="btn btn-outline-secondary border-0 bg-pink text-white w-25" type="button" value="開始規劃路線">
            </form>
        </div>
        <!-- 輸入出發地點 end-->
        <!-- 地圖建議路線 start-->
        <div class="startPosition col-12 px-0 py-5">
            <div class="mb-4">
                <h4 class="col-6 col-md-4 px-0 my-auto mt-3 font-weight-bold">建議路線</h4>
                <hr>
                <br>
            </div>

            <!-- 導入地圖api -->
            <div>
                <img src="/image/map.png" class="w-100">
            </div>
        </div>
        <!-- 地圖建議路線 end-->
    </div>
</div>
@section css{
    <style>

        .addShowPage {
            border-style: none;
            background-color: transparent;
        }

            .addShowPage > i {
                font-size: 12px;
            }


        .controlBtn {
            border-style: none;
            background-color: transparent;
            margin-left:7px;
        }

        .showPageUrl {
            text-decoration: none;
            color: black;
            transition: all .3s ease-in-out;
        }

            .showPageUrl:hover {
                text-decoration: none;
                color: rgb(197, 126, 104);
            }

    </style>

    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="~/Content/spinkit.min.css" rel="stylesheet" />
}

@section scripts{
    <script>
        $(function () {
            $("#sortable").sortable();

            $('#StartDate').change(function () {
                searchShowPage();
                $('#sortable').html('');
            });

            $('#StartTime').change(function () {
                searchShowPage();
                $('#sortable').html('');
            });

            $('#EndTime').change(function () {
                searchShowPage();
                $('#sortable').html('');
            });

            $('#FK_City').change(function () {
                searchShowPage();
            });


        });

        function searchShowPage() {
            let cityId = $('#FK_City').val();
            let StartDate = $('#StartDate').val();
            let StartTimeStr = document.getElementById('StartTime').value;
            let EndTimeStr = document.getElementById('EndTime').value;
            console.log($('#StartDate').val());
            if (StartDate == '') {

                let today = new Date();
                $('#StartDate').val(`${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`);
                StartDate = $('#StartDate').val();
            }

            if (StartTimeStr == '') {
                document.getElementById('StartTime').selectedIndex = 1;
                StartTimeStr = document.getElementById('StartTime').value;
            }

            if (EndTimeStr == '') {
                let optionSize = document.getElementById('EndTime').options.length;
                document.getElementById('EndTime').selectedIndex = optionSize - 1;
                EndTimeStr = document.getElementById('EndTime').value;
            }

            loadingShowPages();

            $.ajax({
                type: 'get',
                url: '@Url.Action("getMyShow", "Common")',
                data: { cityId: cityId, StartDate: StartDate, StartTime: StartTimeStr, EndTime: EndTimeStr },
                success: function (data) {
                    $('#MyShowPage').html(data);

                }, error: function (jqXHR, textStatus, errorThrown) {
                    Swal.fire({
                        icon: 'error',
                        title: textStatus,
                        text: errorThrown,
                        showConfirmButton: false,
                        showCancelButton: true
                    });
                }
            });
        }

        //新增展覽至行程排序
        function addShowPage(event) {
            let sibling = event.target;

            //取得父元素＝'td'
            do {
                sibling = sibling.parentElement;
            } while (sibling.nodeName != 'TD');

            //複製元素
            sibling = sibling.nextElementSibling.cloneNode(true);

            let trSize = document.querySelectorAll('#sortable>tr').length;

            let thTag = document.createElement('th');
            thTag.textContent = `${trSize + 1}`;
            thTag.setAttribute('scope', 'row');

            let controls = document.createElement('td');
            controls.className = 'btn-group';

            //up
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="upShowPage(event)"><i class="fas fa-chevron-up"></i></button>';

            //down
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="downShowPage(event)"><i class="fas fa-chevron-down"></i></button>';

            //top
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="topShowPage(event)"><i class="fas fa-angle-double-up"></i></button>';

            //last
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="lastShowPage(event)"><i class="fas fa-angle-double-down"></i></button>';

            //remove
            controls.innerHTML += '<button type="button" class="px-1 controlBtn" onclick="removeShowPage(event)"><i class="fa fa-minus"></i></button>';

            let trTag = document.createElement('tr');
            trTag.appendChild(thTag);//th
            trTag.appendChild(sibling);//td
            trTag.appendChild(controls);//td

            document.getElementById('sortable').appendChild(trTag);
        }

        function upShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.firstElementChild)
                return;

            let temp = target.cloneNode(true);
            parent.insertBefore(temp, target.previousElementSibling);
            parent.removeChild(target);
        }

        function downShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.lastElementChild)
                return;

            parent.insertBefore(target.nextElementSibling, target);
        }

        function topShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.firstElementChild)
                return;

            let temp = target.cloneNode(true);

            parent.replaceChild(parent.firstElementChild, target);
            parent.insertBefore(temp,parent.firstElementChild);
        }

        function lastShowPage(event) {
            let target = event.target;
            let parent = document.getElementById('sortable');

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            if (target == parent.lastElementChild)
                return;

            let temp = target.cloneNode(true);

            parent.replaceChild(parent.lastElementChild, target);
            parent.appendChild(temp);
        }

        //從行程排序移除展覽
        function removeShowPage(event) {
            let target = event.target;

            //取得父元素＝'td'
            do {
                target = target.parentElement;
            } while (target.nodeName != 'TR');

            document.getElementById('sortable').removeChild(target);
        }

        function loadingShowPages() {
            $('#MyShowPage').html('<div class="sk-wave" style="margin:50px auto;"><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div><div class="sk-wave-rect"></div></div>');
        }

        function errorServerMsg() {
            $('#showPages').html('<br /><br /><h1>伺服器發生錯誤，無法取得資料</h1>');
        }
    </script>
}